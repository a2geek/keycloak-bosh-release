#!/bin/bash -e

source /var/vcap/packages/openjdk/bosh/runtime.env

store_data_dir=/var/vcap/store/keycloak/data
package_data_dir=/var/vcap/packages/keycloak/data
mkdir -p $store_data_dir $keycloak_data_dir
ln -sf $store_data_dir $package_data_dir

file=/var/vcap/packages/keycloak/prestart-done
if [ ! -f $file ]
then
    echo "Running pre-start."

    export QUARKUS_PACKAGE_OUTPUT_DIRECTORY=/var/vcap/data/keycloak/build

    mkdir -p $QUARKUS_PACKAGE_OUTPUT_DIRECTORY
    cp -r /var/vcap/packages/keycloak/lib/* $QUARKUS_PACKAGE_OUTPUT_DIRECTORY

    /var/vcap/packages/keycloak/bin/kc.sh \
        --config-file /var/vcap/jobs/keycloak/config/keycloak.conf \
        -Djava.io.tmpdir=/var/vcap/data/keycloak/tmp \
        build

    touch $file

else
    echo "Pre-start already ran."
fi
